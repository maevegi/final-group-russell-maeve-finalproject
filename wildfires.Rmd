---
Title: Wilfire Frequency, Severity and Climate Change in California
author: Russell Huang and Maeve Gilbert
output: 
 html_document:
   df_print: paged 
 github_document: 
 pdf_document:
---
```{r}
library(tidyverse)
#install.packages(raster)
library(raster)
library(tmap)
library(terra)
library(sf)
library(ggplot2)
library(stars)
#install.packages("XML")
library(XML)
library(methods)
library(xml2)
```

## Introduction

Three skills we are using in this module
-Expansion of ggplot functions (to include more than default characteristics)
-Use of at least 5 `dplyr` verbs / functions
-
Make sure to knit to pdf document when finished. 


## Formatting the Data
Read in the data sets. 
```{r} 
fire <- read_csv("https://incidents.fire.ca.gov/imapdata/mapdataall.csv",
                 col_types="ccTTc?ccddccddcccTDDcll")
```

Selecting relevant columns from the data. Excluding singular data point form 1969 to create consistent time frame with the climate data and exclude outliers. 
```{r}
#colnames(fire)

acres<-fire |>
  dplyr::select(incident_name, incident_date_created, incident_county, incident_location, incident_acres_burned, incident_longitude, incident_latitude) |>
  mutate(year = str_extract(incident_date_created, "\\d{4}")) |>
  group_by(year) |>
    summarise(total_acres_burned = sum(incident_acres_burned, na.rm = TRUE))

acres_burned<-acres[-c(1), ]
acres_burned


```

Changing notation so that it does not display scientific notation. Graphing acres burned over time span 2009-2023.
```{r}
options(scipen=999)
graph<- acres_burned|>
  ggplot(aes(x=year, y=total_acres_burned))+
  geom_point()+
  xlab("Year")+
  ylab("Number of Acres Burned")+
  #scale_y_continuous(labels = )
  ggtitle("Acres burned in CA Wildfires, 1969-2023")
graph

```


```{r}
plot(new, max.plot=17)
points(x = fire$incident_longitude, y= fire$incident_latitude, col = "red")


#create new raster for each year
#group by year, map all incidents per year on one raster, create one raster per year
#need to combine all incidents for each year and calculate total acres burned per year
```
We need to read in climate data, determine whether this should be monthly or daily values. Also should see if we can incorporate a spatial element to this, for example using a raster of California to plot fire spatial distribution over time. 

California shapefile. 
```{r}
download.file("https://data.ca.gov/dataset/e212e397-1277-4df3-8c22-40721b095f33/resource/3db1e426-fb51-44f5-82d5-a54d7c6e188b/download/ca-state-boundary.zip", "ca-state-boundary.zip")
unzip("ca-state-boundary.zip")
CAfile<- "https://data.ca.gov/dataset/e212e397-1277-4df3-8c22-40721b095f33/resource/3db1e426-fb51-44f5-82d5-a54d7c6e188b/download/ca-state-boundary.zip" 

CAurl<- paste0("/vsizip/vsicurl/", CAfile)
shapefile<- read_sf(CAurl)
summary(shapefile)

tm_shape(shapefile)+ tm_polygons("ALAND")
tm_shape(shapefile)+tm_polygons("GEOID")
```

Counties shapefile from folder CA_Counties
```{r}

download.file("https://data.ca.gov/dataset/e212e397-1277-4df3-8c22-40721b095f33/resource/b0007416-a325-4777-9295-368ea6b710e6/download/ca-county-boundaries.zip", "ca-county-boundaries.zip")
unzip("ca-county-boundaries.zip")
counties<-"https://data.ca.gov/dataset/e212e397-1277-4df3-8c22-40721b095f33/resource/b0007416-a325-4777-9295-368ea6b710e6/download/ca-county-boundaries.zip"
counties_url<-paste0("/vsizip/vsicurl/", counties)

  
tmap_options(max.categories=58) 
counties_sf<-read_sf("CA_Counties", layer="CA_Counties_TIGER2016")
summary(counties_sf)
plot(counties_sf)
CA<-tm_shape(counties_sf) + tm_polygons("COUNTYFP")
plot(CA)

```
Trying shapefile from folder "County".
```{r}
new<-read_sf("County", layer="CaliforniaCounty", quiet=TRUE)
new|>plot()|>
points(x = fire$incident_longitude, y= fire$incident_latitude, col = "red", coords)
tm_shape(new)+tm_polygons("COUNTFP")+ points(x = fire$incident_longitude, y= fire$incident_latitude, col = "red")

st_bbox(new)


#make bounding box to define coordinates 
```
Reading in temperature data from 2009-2023, dropping extraneous time stamp details to limit the date to a four-digit year. Value represents average temperature in degrees farenheit. Anomaly represents deviation from average, calculated from the mean temperature between 1901-2000. 
```{r}

temp<-read_csv("https://www.ncei.noaa.gov/access/monitoring/climate-at-a-glance/statewide/time-series/4/tavg/12/12/2009-2023.csv?base_prd=true&begbaseyear=1901&endbaseyear=2000",
               skip=4)
new_temp<-temp|>
  mutate(Date = str_extract(Date, "\\d{4}"))|>
  rename(Avg_Temp=Value)
new_temp


```

Precipitation data from 2009-2023. Same mutation performed on the years to show a four digit date. Precipitation listed in total inches per twelve month period. Anomaly is deviation from average calculated from 1901-2000. 
```{r}
precipitation<- read_csv("https://www.ncei.noaa.gov/access/monitoring/climate-at-a-glance/statewide/time-series/4/pcp/12/12/2009-2023.csv?base_prd=true&begbaseyear=1901&endbaseyear=2000",
                         skip=4)
new_precip<-precipitation|>
  mutate(Date = str_extract(Date, "\\d{4}"))|>
  rename(Avg_Precipitation=Value)
new_precip
```
Combined table with acres burned and temperature
```{r}
megatable<- left_join(acres_burned, new_temp, by = c("year" = "Date"))|>
  left_join(new_precip, by=c("year"="Date"))|>
  dplyr::select("year", "total_acres_burned", "Avg_Temp", "Avg_Precipitation")
megatable
```

```{r}
ylim.prim <- c(122, 2942034)
ylim.sec <- c(58.8, 61.5)

b <- diff(ylim.prim)/diff(ylim.sec)
a <- ylim.prim[1] - b*ylim.sec[1]

ggplot(megatable, aes(year, total_acres_burned)) +
  geom_line() + 
  geom_line(aes(y = a + Avg_Temp*b), color = "red") +
  scale_y_continuous("total_acres_burned", sec.axis = sec_axis(~ (. -a)/b, name = "Avg_Temp"))
```



```{r}
par(new=TRUE)
fire_temp<-ggplot()+
  geom_line(data=acres_burned, mapping=aes(x=year, y=total_acres_burned))+
  geom_line(data=new_temp, mapping=aes(x=Date, y=Value))
fire_temp
```

# Works Cited
Climate data obtained from:
NOAA National Centers for Environmental information, Climate at a Glance: Statewide Time Series, published November 2023, retrieved on December 4, 2023 from https://www.ncei.noaa.gov/access/monitoring/climate-at-a-glance/statewide/time-series
Fire incident data obtained from:
https://www.fire.ca.gov/incidents
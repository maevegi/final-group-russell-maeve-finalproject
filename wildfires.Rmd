---
Title: Wilfire Frequency, Severity and Climate Change in California
author: Russell Huang and Maeve Gilbert
output: 
 html_document:
   df_print: paged 
 github_document: 
 pdf_document:
---
```{r}
library(tidyverse)
#install.packages(raster)
library(raster)
library(tmap)
library(terra)
library(sf)
library(ggplot2)
library(stars)
#install.packages("XML")
library(XML)
library(methods)
library(xml2)
```

## Introduction

For the state of California, wildfires are perhaps one of the most pressing concerns in terms of the future of climate change. In order to examine the relationship between climate change and wildifire extent, we are examining average temperature and precipitation compared to the number of acres burned per year, in a period from 2009-2023. Our analysis is loosely based on that of Krawchuk and Moritz (2012). However, due to difficulties in accessing the exact data used in this study, our scope is limited to a 13 year time span. Our temperature data is also obtained from the NOAA National Centers for Environmental Information rather than the PRISM project, which the authors used. Due to these differences, our results and analysis of the data are different than those of the paper. 

Three skills we are using in this module
-Expansion of ggplot functions (to include more than default characteristics)
-Use of at least 5 `dplyr` verbs / functions
-Use of spatial vector data (sf package) and visualization of spatial data
Make sure to knit to pdf document when finished. 


## Formatting the Data
The first step in analyzig wildfire data is to obtai information regarding fire incident dates, locations, longtidue and latitude, and the number of acres burned. Our data is collected from CalFire. The second step performed here transforms the longitude and latitude points from this .csv file into a spatial object so that we can later map these points onto and sf file of the state. Additionally, because the points have no specified crs boundaries, they are assigned the same boundaries as that of our California shapefile. 
```{r} 
fire <- read_csv("https://incidents.fire.ca.gov/imapdata/mapdataall.csv",
                 col_types="ccTTc?ccddccddcccTDDcll")
fire_spatial<- st_as_sf(fire, coords=c("incident_longitude", "incident_latitude"))

st_crs(fire_spatial)<- st_crs(new)
```

Because the csv file contains many columns that are not relevant to our current analysis, we are selecting only the relevant columns from the data. Additionally, the data contain a singular observation in 1969, with the next available dat being 2009. Due to the large gap between years and potential problems with calculating trends, we are excluding the data from 1969 to create a consistent time frame that will match with our climate data. With this information, we are the acres burned for each incident each year to get a total acres burned value. It should be noted that data for 2023 is up until the point we accessed the data, but may be slightly different. However, the likelihood of another wildfire occuring in December is low. 
```{r}

acres<-fire |>
  dplyr::select(incident_name, incident_date_created, incident_county, incident_location, incident_acres_burned, incident_longitude, incident_latitude) |>
  mutate(year = str_extract(incident_date_created, "\\d{4}")) |>
  group_by(year) |>
    summarise(total_acres_burned = sum(incident_acres_burned, na.rm = TRUE))

acres_burned<-acres[-c(1), ]



```

We chose to change the default graphing setting from scientific notation to plain integers to show the acres burned in a clearer manner. Here, we are  showing the number of acres burned in wildfires every year from 2009 to 2023. 
```{r}
options(scipen=999)
graph<- acres_burned|>
  ggplot(aes(x=year, y=total_acres_burned))+
  geom_point()+
  xlab("Year")+
  ylab("Number of Acres Burned")+
  ggtitle("Acres burned in CA Wildfires, 1969-2023")


```


```{r}
Trying shapefile from folder "County".
{r}
new <- read_sf("County", layer="CaliforniaCounty", quiet=TRUE)

tm_shape(new)+tm_polygons()+
  tm_shape(fire_spatial)+
  tm_dots("incident_acres_burned")+
  tm_layout(legend.width=0.6)
  #tm_legend(legend.format(fun=)


  group_by(incident_date_created)

  vector1<-c()  
  for (i in 1:nrow(fire_spatial)){
    vector1<-tm_shape(new)+tm_polygons()+
      tm_shape(fire_spatial)+
      tm_dots("incident_acres_burned")
    print(vector1)
  }
  
fire_spatial|>
  mutate(year = str_extract(incident_date_created, "\\d{4}"))|>
  select(year= "2009")

tm_shape(new) + tm_polygons()+
  tm_shape(fire_spatial, filter=TRUE)+
tm_dots("incident_acres_burned") + 
tm_facets(nrow = 14, sync = TRUE)
  
  
loop<-for(i in 1:nrow(fire_spatial)){
 vector<-tm_shape(new)+tm_polygons()+
  tm_shape(fire_spatial)+
  tm_dots("incident_acres_burned") 
}
loop
```

Because our analysis is focused on how climate changes influence wildfires, we need to read in climate data containing precipitation and average temperature values. Since the time frame for fire data was 2009-2023, we are using this same period to obtain temperature data. Due to the formatting of the data, we needed to drop extraneous time stamp details to limit the date to a four-digit year. We renamed the "Value" column to Avg_Temp, which represents average temperature in degrees Fahrenheit. Anomaly represents the deviation from an average, calculated from the mean temperature between 1901-2000. Note that because the year 2023 is not over, our data only goes until 2022. 
```{r}

temp<-read_csv("https://www.ncei.noaa.gov/access/monitoring/climate-at-a-glance/statewide/time-series/4/tavg/12/12/2009-2023.csv?base_prd=true&begbaseyear=1901&endbaseyear=2000",
               skip=4)

new_temp<-temp|>
  mutate(Date = str_extract(Date, "\\d{4}"))|>
  rename(Avg_Temp=Value)
new_temp


```

Next, we collected precipitation data from 2009-2023. We applied the same manipulation on the years column to show a four digit date. Precipitation is listed in total inches per twelve month period. This column was renamed Avg_Precipitation (formerly Value). Anomaly represents the deviation from the average calculated from 1901-2000. 
```{r}
precipitation<- read_csv("https://www.ncei.noaa.gov/access/monitoring/climate-at-a-glance/statewide/time-series/4/pcp/12/12/2009-2023.csv?base_prd=true&begbaseyear=1901&endbaseyear=2000",
                         skip=4)
new_precip<-precipitation|>
  mutate(Date = str_extract(Date, "\\d{4}"))|>
  rename(Avg_Precipitation=Value)
new_precip
```

Our first method of comparison was to plot each graph side by side. To do this, we first combined all three tables (acres burned, temperature, and precipitation) and changed all of the columns from Date to year. We then excluded the column containing the anomaly values, since this was unncessary for the analysis. In order to 
```{r}
megatable<- left_join(acres_burned, new_temp, by = c("year" = "Date"))|>
  left_join(new_precip, by=c("year"="Date"))|>
  dplyr::select("year", "total_acres_burned", "Avg_Temp", "Avg_Precipitation")

experiment<-pivot_longer(megatable, cols=total_acres_burned:Avg_Precipitation, names_to="variable", values_to="data")

ggplot(experiment, aes(x=year, y=data))+geom_line(group=1)+facet_wrap(~variable, scales="free")+  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
 


```

Graph with total acres burned and average annual temperatures 
```{r}

ylim.prim <- c(122, 2942034)
ylim.sec <- c(58.8, 61.5)

b <- diff(ylim.prim)/diff(ylim.sec)
a <- ylim.prim[1] - b*ylim.sec[1]

ggplot(megatable, aes(year, total_acres_burned)) +
  geom_line(group=1, aes(color="red")) + 
  geom_line(group=1, aes(y = a + Avg_Temp*b ,  show.legend = TRUE, color="darkgreen"))+
  scale_y_continuous("Total Acres Burned", sec.axis = sec_axis(~ (. -a)/b, name = "Avg_Temp (F)")) +
  ggtitle("Total Acres Burned & Average Temperature, 2009-2023") +
   theme(axis.text.x = element_text(angle = 90))+
  scale_color_identity(name = "Variable",
                          breaks = c("red", "darkgreen"),
                          labels = c("Total Acres Burned", "Average Temperature"),
                          guide = "legend")
```

```{r}

ylim.prim <- c(122, 2942034)
ylim.sec <- c(58.8, 61.5)

b <- diff(ylim.prim)/diff(ylim.sec)
a <- ylim.prim[1] - b*ylim.sec[1]

cool_plot_bro <- ggplot(megatable, aes(year, total_acres_burned)) +
  geom_line(group=1, aes(color= "gray")) + 
  geom_line(aes(y = a + Avg_Temp*b), color = "darkgreen", group=1) +
  scale_y_continuous("Total Acres Burned", sec.axis = sec_axis(~ (. -a)/b, name = "Avg_Temp (F)")) +
  ggtitle("Total Acres Burned & Average Temperature",  subtitle="2009-20223" ) +
  
  #scale_color_manual(name = 'Variables',
                     #breaks = c('total_acres_burned', 'Avg_Temp'),
                    # values = c('red', 'darkgreen')) + 
  geom_text(aes(x = 8, y = 15, label = "-- = total_acres_burned"), color = "gray")
cool_plot_bro 
```

Graph with total acres burned and annual precipitation values
```{r}
primary_y<-c(122, 2942034)
secondary_y<- c(7.93, 29.12)

d <- diff(primary_y)/diff(secondary_y)
c <- primary_y[1] - d*secondary_y[1]

ggplot(megatable, aes(year, total_acres_burned)) +
  geom_line(group=1, aes(color="red")) + 
  geom_line(aes(y = c + Avg_Precipitation*d, color = "blue"), group=1) +
  scale_y_continuous("total_acres_burned", sec.axis = sec_axis(~ (.-c)/d, name = "Avg_Precipitation")) +
  ggtitle("Total Acres Burned and Average Precipitation", subtitle=" 2009-2023")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_color_identity(name = "Variable",
                          breaks = c("red", "blue"),
                          labels = c("Total Acres Burned", "Average Precipitation"),
                          guide = "legend")

```

Graph with average annual temperatures and annual precipitation values. Values for 2023 are missing since the year has not ended and the data has not been finalized. 
```{r}
Avg_Temp_y <- c(58.8, 61.5)
Avg_Precipitation_y <- c(7.93, 29.12)

f <- diff(Avg_Temp_y)/diff(Avg_Precipitation_y)
e <- Avg_Temp_y[1] - f*Avg_Precipitation_y[1]

ggplot(megatable, aes(year, Avg_Temp)) +
  geom_line(group=1, aes(color="darkgreen")) + 
  geom_line(aes(y = e + Avg_Precipitation*f, color = "blue"), group=1) +
  scale_y_continuous("Avgerage Temperature (F)", sec.axis = sec_axis(~ (.-e)/f, name = "Average Annual Precipitation(in)")) +
  ggtitle("Average Temperature and Annual Precipitation,  2009-2023")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_color_identity(name = "Variable",
                          breaks = c("darkgreen", "blue"),
                          labels = c("Average Temperature", "Average Precipitation"),
                          guide = "legend")
```

#notes for office hours:
- adding a legend to ggplots 
-adding longitude and latitude points to rasters, creating raster for each year and using predictor equations 
-clarify how the transformation equations work 

# Works Cited
Climate data obtained from:
NOAA National Centers for Environmental information, Climate at a Glance: Statewide Time Series, published November 2023, retrieved on December 4, 2023 from https://www.ncei.noaa.gov/access/monitoring/climate-at-a-glance/statewide/time-series
Fire incident data obtained from:
https://www.fire.ca.gov/incidents
Some code based on data from:
https://stackoverflow.com/questions/3099219/ggplot-with-2-y-axes-on-each-side-and-different-scales
Initial Paper:
Krawchuk, M., & Moritz, M. (2012). Fire and Climate Change in California: Changes in the Distribution and Frequency of Fire in Climates of the Future and Recent Past (1911-2099). UC Berkeley: California Institute for Energy and Environment (CIEE). Retrieved from https://escholarship.org/uc/item/5wd1797m
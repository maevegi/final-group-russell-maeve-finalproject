---
Title: Wilfire Frequency, Severity and Climate Change in California
author: Russell Huang and Maeve Gilbert
output: 
 html_document:
   df_print: paged 
 github_document: 
 pdf_document:
---
```{r}
library(tidyverse)
#install.packages(raster)
library(raster)
library(tmap)
library(terra)
library(sf)
library(ggplot2)
library(stars)
#install.packages("XML")
library(XML)
library(methods)
library(xml2)
```

## Introduction

Three skills we are using in this module
-Expansion of ggplot functions (to include more than default characteristics)
-Use of at least 5 `dplyr` verbs / functions
-
Make sure to knit to pdf document when finished. 


## Formatting the Data
Read in the data sets. 
```{r} 
fire <- read_csv("https://incidents.fire.ca.gov/imapdata/mapdataall.csv",
                 col_types="ccTTc?ccddccddcccTDDcll")
fire_spatial<- st_as_sf(fire, coords=c("incident_longitude", "incident_latitude"))

st_crs(fire_spatial)<- st_crs(new)
```

Selecting relevant columns from the data. Excluding singular data point form 1969 to create consistent time frame with the climate data and exclude outliers. 
```{r}
colnames(fire)

acres<-fire |>
  dplyr::select(incident_name, incident_date_created, incident_county, incident_location, incident_acres_burned, incident_longitude, incident_latitude) |>
  mutate(year = str_extract(incident_date_created, "\\d{4}")) |>
  group_by(year) |>
    summarise(total_acres_burned = sum(incident_acres_burned, na.rm = TRUE))

acres_burned<-acres[-c(1), ]
acres_burned


```

Changing notation so that it does not display scientific notation. Graphing acres burned over time span 2009-2023.
```{r}
options(scipen=999)
graph<- acres_burned|>
  ggplot(aes(x=year, y=total_acres_burned))+
  geom_point()+
  xlab("Year")+
  ylab("Number of Acres Burned")+
  #scale_y_continuous(labels = )
  ggtitle("Acres burned in CA Wildfires, 1969-2023")
graph

```


```{r}
plot(new, max.plot=17)
points(x = fire$incident_longitude, y= fire$incident_latitude, col = "red")


#create new raster for each year
#group by year, map all incidents per year on one raster, create one raster per year
#need to combine all incidents for each year and calculate total acres burned per year
```
We need to read in climate data, determine whether this should be monthly or daily values. Also should see if we can incorporate a spatial element to this, for example using a raster of California to plot fire spatial distribution over time. 


Trying shapefile from folder "County".
```{r}
new<-read_sf("County", layer="CaliforniaCounty", quiet=TRUE)

summary(new)
tm_shape(new)+tm_polygons("COUNTYFP")+tm_legend(legend.show=FALSE)+ tm_shape(fire_spatial)+tm_dots("incident_acres_burned")

?tm_legend

tm_shape(new)+tm_polygons()+
  tm_shape(fire_spatial)+
  tm_dots("incident_acres_burned")+
  tm_legend(legend.format(fun=)

loop<-for(i in 1:nrow(fire_spatial)){
 tm_shape(new)+tm_polygons()+
  tm_shape(fire_spatial)+
  tm_dots("incident_acres_burned") 
}
loop
```


Reading in temperature data from 2009-2023, dropping extraneous time stamp details to limit the date to a four-digit year. Value represents average temperature in degrees Farenheit. Anomaly represents deviation from average, calculated from the mean temperature between 1901-2000. 
```{r}

temp<-read_csv("https://www.ncei.noaa.gov/access/monitoring/climate-at-a-glance/statewide/time-series/4/tavg/12/12/2009-2023.csv?base_prd=true&begbaseyear=1901&endbaseyear=2000",
               skip=4)

new_temp<-temp|>
  mutate(Date = str_extract(Date, "\\d{4}"))|>
  rename(Avg_Temp=Value)
new_temp


```

Precipitation data from 2009-2023. Same mutation performed on the years to show a four digit date. Precipitation listed in total inches per twelve month period. Anomaly is deviation from average calculated from 1901-2000. 
```{r}
precipitation<- read_csv("https://www.ncei.noaa.gov/access/monitoring/climate-at-a-glance/statewide/time-series/4/pcp/12/12/2009-2023.csv?base_prd=true&begbaseyear=1901&endbaseyear=2000",
                         skip=4)
new_precip<-precipitation|>
  mutate(Date = str_extract(Date, "\\d{4}"))|>
  rename(Avg_Precipitation=Value)
new_precip
```
Combined table with acres burned and temperature
```{r}
megatable<- left_join(acres_burned, new_temp, by = c("year" = "Date"))|>
  left_join(new_precip, by=c("year"="Date"))|>
  dplyr::select("year", "total_acres_burned", "Avg_Temp", "Avg_Precipitation")

experiment<-pivot_longer(megatable, cols=total_acres_burned:Avg_Precipitation, names_to="variable", values_to="data")
ggplot(experiment, aes(x=year, y=data))+geom_line(group=1)+facet_wrap(~variable, scales="free")
```

Graph with total acres burned and average annual temperatures 
```{r}
ylim.prim <- c(122, 2942034)
ylim.sec <- c(58.8, 61.5)

b <- diff(ylim.prim)/diff(ylim.sec)
a <- ylim.prim[1] - b*ylim.sec[1]

ggplot(megatable, aes(year, total_acres_burned)) +
  geom_line(group=1, aes(color="red")) + 
  geom_line(aes(y = a + Avg_Temp*b), color = "darkgreen", group=1) +
  scale_y_continuous("Total Acres Burned", sec.axis = sec_axis(~ (. -a)/b, name = "Avg_Temp (F)")) +
  ggtitle("Total Acres Burned & Average Temperature, 2009-2023") +
  scale_color_manual(name = 'Variables',
                     breaks = c('total_acres_burned', 'Avg_Temp'),
                     values = c('red', 'darkgreen'))
                     
```

Graph with total acres burned and annual precipitation values
```{r}
primary_y<-c(122, 2942034)
secondary_y<- c(7.93, 29.12)

d <- diff(primary_y)/diff(secondary_y)
c <- primary_y[1] - d*secondary_y[1]

ggplot(megatable, aes(year, total_acres_burned)) +
  geom_line(group=1, color="red") + 
  geom_line(aes(y = c + Avg_Precipitation*d), color = "blue", group=1) +
  scale_y_continuous("total_acres_burned", sec.axis = sec_axis(~ (.-c)/d, name = "Avg_Precipitation")) +
  ggtitle("Total Acres Burned and Average Precipitation, 2009-2023")
```

Graph with average annual temperatures and annual precipitation values. Values for 2023 are missing since the year has not ended and the data has not been finalized. 
```{r}
Avg_Temp_y <- c(58.8, 61.5)
Avg_Precipitation_y <- c(7.93, 29.12)

f <- diff(Avg_Temp_y)/diff(Avg_Precipitation_y)
e <- Avg_Temp_y[1] - f*Avg_Precipitation_y[1]

ggplot(megatable, aes(year, Avg_Temp)) +
  geom_line(group=1, color="darkgreen") + 
  geom_line(aes(y = e + Avg_Precipitation*f), color = "blue", group=1) +
  scale_y_continuous("Avgerage Temperature (F)", sec.axis = sec_axis(~ (.-e)/f, name = "Average Annual Precipitation(in)")) +
  ggtitle("Average Temperature and Annual Precipitation,  2009-2023")
```

#notes for office hours:
- adding a legend to ggplots
-adding longitude and latitude points to rasters, creating raster for each year and using predictor equations 
-clarify how the transformation equations work 

# Works Cited
Climate data obtained from:
NOAA National Centers for Environmental information, Climate at a Glance: Statewide Time Series, published November 2023, retrieved on December 4, 2023 from https://www.ncei.noaa.gov/access/monitoring/climate-at-a-glance/statewide/time-series
Fire incident data obtained from:
https://www.fire.ca.gov/incidents
Some code based on data from:
https://stackoverflow.com/questions/3099219/ggplot-with-2-y-axes-on-each-side-and-different-scales